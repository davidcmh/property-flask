const updateMap = (latLng) => {

  // note: `map` var is defined outside in google_map.js, which is generated by flask-googlemaps
  map.setCenter(latLng);

  // clear existing markers by setting associated map to null
  for (var i = 0; i < map_markers.length; i++) {
    map_markers[i].setMap(null);
  }
  map_markers = [];

  // add new marker for current latLng
  var marker = new google.maps.Marker({
    position: latLng,
    map: map,
  });
  map_markers.push(marker)
};

document.addEventListener('DOMContentLoaded', () => {

  document.querySelector('#form').onsubmit = () => {

    const request = new XMLHttpRequest();
    const postcode = document.querySelector('#postcode-input').value;

    request.open('POST', '/postcode');

    request.onload = () => {
      const data = JSON.parse(request.responseText);

      if (data.success) {
        const result = data.result;
        let content = `<div>Postcode: ${result.postcode}</div>`;
        content += `<div>${result.admin_district}, ${result.region}, ${result.country} </div>`;
        document.querySelector('#result').innerHTML = content;

        updateMap({lat: result.latitude, lng: result.longitude});
      }
      else {
        document.querySelector('#result').innerHTML = 'There was an error.';
      }

    };

    const data = new FormData();
    data.append('postcode', postcode);
    request.send(data);

    return false;
  };

  // initialise page with default postcode
  document.querySelector('#postcode-input').value = "W1W 5PN";
  document.querySelector('#submit-form').click();
});
